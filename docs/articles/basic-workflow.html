<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Basic workflow • cwi</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Basic workflow">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cwi</a>
        <span class="label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic-workflow.html">Basic workflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CT-Data-Haven/cwi">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Basic workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/CT-Data-Haven/cwi/blob/master/vignettes/basic-workflow.Rmd"><code>vignettes/basic-workflow.Rmd</code></a></small>
      <div class="hidden name"><code>basic-workflow.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(purrr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(camiller)
<span class="kw">library</span>(cwi)</code></pre></div>
<p>The tables I’m working with are <code>B01003</code>, total population; <code>B03002</code>, race and Latino ethnicity; and <code>B25003</code>, housing tenure. It’s easiest to save these in a named list, then map over the list calling <code>multi_geo_acs</code> for each table number.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">year &lt;-<span class="st"> </span><span class="dv">2016</span>
table_nums &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">total_pop =</span> <span class="st">"B01003"</span>, 
  <span class="dt">race =</span> <span class="st">"B03002"</span>,
  <span class="dt">tenure =</span> <span class="st">"B25003"</span>
)</code></pre></div>
<div id="fetching-data-from-acs" class="section level1">
<h1 class="hasAnchor">
<a href="#fetching-data-from-acs" class="anchor"></a>Fetching data from ACS</h1>
<p>I’m pulling out the entries in the <code>cwi</code> dataset <code>regions</code> (a list) to only include the Greater New Haven-area ones. Then I fetch the ACS tables, and filter them to only have geographic levels other than town, or to only be towns in Greater New Haven.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gnh_regions &lt;-<span class="st"> </span>regions[<span class="kw">c</span>(<span class="st">"Greater New Haven"</span>, <span class="st">"New Haven Inner Ring"</span>, <span class="st">"New Haven Outer Ring"</span>)]

gnh_data &lt;-<span class="st"> </span>table_nums <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(<span class="op">~</span><span class="kw"><a href="../reference/multi_geo_acs.html">multi_geo_acs</a></span>(<span class="dt">table =</span> ., 
                     <span class="dt">year =</span> year, 
                     <span class="dt">towns =</span> <span class="st">"all"</span>, 
                     <span class="dt">regions =</span> gnh_regions, 
                     <span class="dt">counties =</span> <span class="st">"New Haven"</span>, 
                     <span class="dt">state =</span> <span class="st">"09"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(<span class="op">~</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(., NAME <span class="op">%in%</span><span class="st"> </span>gnh_regions<span class="op">$</span><span class="st">`</span><span class="dt">Greater New Haven</span><span class="st">`</span> <span class="op">|</span><span class="st"> </span>level <span class="op">!=</span><span class="st"> "4_towns"</span>))
<span class="co">#&gt; Table: TOTAL POPULATION</span>
<span class="co">#&gt; Geographies included:</span>
<span class="co">#&gt; Towns: all</span>
<span class="co">#&gt; Regions: Greater New Haven, New Haven Inner Ring, New Haven Outer Ring</span>
<span class="co">#&gt; Counties: New Haven County</span>
<span class="co">#&gt; State: 09</span>
<span class="co">#&gt; Table: HISPANIC OR LATINO ORIGIN BY RACE</span>
<span class="co">#&gt; Geographies included:</span>
<span class="co">#&gt; Towns: all</span>
<span class="co">#&gt; Regions: Greater New Haven, New Haven Inner Ring, New Haven Outer Ring</span>
<span class="co">#&gt; Counties: New Haven County</span>
<span class="co">#&gt; State: 09</span>
<span class="co">#&gt; Table: TENURE</span>
<span class="co">#&gt; Geographies included:</span>
<span class="co">#&gt; Towns: all</span>
<span class="co">#&gt; Regions: Greater New Haven, New Haven Inner Ring, New Haven Outer Ring</span>
<span class="co">#&gt; Counties: New Haven County</span>
<span class="co">#&gt; State: 09</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gnh_data<span class="op">$</span>total_pop
<span class="co">#&gt; # A tibble: 18 x 8</span>
<span class="co">#&gt;    GEOID    NAME         variable  estimate   moe level   state county    </span>
<span class="co">#&gt;    &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;     </span>
<span class="co">#&gt;  1 09       Connecticut  B01003_0…  3588570    NA 1_state &lt;NA&gt;  &lt;NA&gt;      </span>
<span class="co">#&gt;  2 09009    New Haven C… B01003_0…   860874    NA 2_coun… 09    &lt;NA&gt;      </span>
<span class="co">#&gt;  3 &lt;NA&gt;     Greater New… B01003_0…   464596   132 3_regi… &lt;NA&gt;  &lt;NA&gt;      </span>
<span class="co">#&gt;  4 &lt;NA&gt;     New Haven I… B01003_0…   145463    57 3_regi… &lt;NA&gt;  &lt;NA&gt;      </span>
<span class="co">#&gt;  5 &lt;NA&gt;     New Haven O… B01003_0…   188728   103 3_regi… &lt;NA&gt;  &lt;NA&gt;      </span>
<span class="co">#&gt;  6 0900904… Bethany      B01003_0…     5521    24 4_towns 09    New Haven…</span>
<span class="co">#&gt;  7 0900907… Branford     B01003_0…    28084    28 4_towns 09    New Haven…</span>
<span class="co">#&gt;  8 0900922… East Haven   B01003_0…    29015    24 4_towns 09    New Haven…</span>
<span class="co">#&gt;  9 0900934… Guilford     B01003_0…    22382    31 4_towns 09    New Haven…</span>
<span class="co">#&gt; 10 0900935… Hamden       B01003_0…    61476    31 4_towns 09    New Haven…</span>
<span class="co">#&gt; 11 0900944… Madison      B01003_0…    18247    21 4_towns 09    New Haven…</span>
<span class="co">#&gt; 12 0900947… Milford      B01003_0…    53430    46 4_towns 09    New Haven…</span>
<span class="co">#&gt; 13 0900952… New Haven    B01003_0…   130405    60 4_towns 09    New Haven…</span>
<span class="co">#&gt; 14 0900953… North Branf… B01003_0…    14310    23 4_towns 09    New Haven…</span>
<span class="co">#&gt; 15 0900954… North Haven  B01003_0…    23888    59 4_towns 09    New Haven…</span>
<span class="co">#&gt; 16 0900957… Orange       B01003_0…    13941    24 4_towns 09    New Haven…</span>
<span class="co">#&gt; 17 0900982… West Haven   B01003_0…    54972    42 4_towns 09    New Haven…</span>
<span class="co">#&gt; 18 0900987… Woodbridge   B01003_0…     8925    33 4_towns 09    New Haven…</span></code></pre></div>
</div>
<div id="aggregating-and-analyzing-data" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregating-and-analyzing-data" class="anchor"></a>Aggregating and analyzing data</h1>
<p>The total population data is very straightforward, as it only has one variable, <code>B01003_001</code>. The tibble returned has the GEOID, except for custom geographies like regions; the name of each geography, including the names of each region; the variable codes; estimates; margins of error at the default 90% confidence level; the geographic level, numbered in order of decreasing size; and the counties of the towns.</p>
<p>The race and ethnicity table will require some calculations, using the brilliantly-titled <a href="https://github.com/camille-s/camiller"><code>camiller</code> package</a>:</p>
<ul>
<li>Using <code><a href="../reference/label_acs.html">label_acs()</a></code>, join the <code>race</code> tibble with the <code>acs_vars</code> dataset to get variable labels. Oftentimes, these labels need to be separated by their <code>"!!"</code> delimeter.</li>
<li>Group by the geographic level, county, and name.</li>
<li>Call <code><a href="http://www.rdocumentation.org/packages/camiller/topics/add_grps">camiller::add_grps</a></code> with a list of racial groups and their labels’ positions in the <code>label</code> column. This gives estimates and, optionally, margins of error for aggregates</li>
<li>
<code><a href="http://www.rdocumentation.org/packages/camiller/topics/calc_shares">camiller::calc_shares</a></code> then gives shares of each group’s estimate over the <code>"total"</code> denominator.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gnh_data<span class="op">$</span>race <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/label_acs.html">label_acs</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(level, county, NAME) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/camiller/topics/add_grps">add_grps</a></span>(<span class="kw">list</span>(<span class="dt">total =</span> <span class="dv">1</span>, <span class="dt">white =</span> <span class="dv">3</span>, <span class="dt">black =</span> <span class="dv">4</span>, <span class="dt">latino =</span> <span class="dv">12</span>, <span class="dt">other =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">9</span>), <span class="dt">group =</span> label) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/camiller/topics/calc_shares">calc_shares</a></span>(<span class="dt">group =</span> label, <span class="dt">denom =</span> <span class="st">"total"</span>)
<span class="co">#&gt; # A tibble: 90 x 6</span>
<span class="co">#&gt; # Groups:   level, county, NAME [18]</span>
<span class="co">#&gt;    level      county NAME             label  estimate  share</span>
<span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;            &lt;fct&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1_state    &lt;NA&gt;   Connecticut      total   3588570 NA    </span>
<span class="co">#&gt;  2 1_state    &lt;NA&gt;   Connecticut      black    347674  0.097</span>
<span class="co">#&gt;  3 1_state    &lt;NA&gt;   Connecticut      latino   537728  0.15 </span>
<span class="co">#&gt;  4 1_state    &lt;NA&gt;   Connecticut      other    238718  0.067</span>
<span class="co">#&gt;  5 1_state    &lt;NA&gt;   Connecticut      white   2464450  0.687</span>
<span class="co">#&gt;  6 2_counties &lt;NA&gt;   New Haven County total    860874 NA    </span>
<span class="co">#&gt;  7 2_counties &lt;NA&gt;   New Haven County black    104831  0.122</span>
<span class="co">#&gt;  8 2_counties &lt;NA&gt;   New Haven County latino   144549  0.168</span>
<span class="co">#&gt;  9 2_counties &lt;NA&gt;   New Haven County other     53796  0.062</span>
<span class="co">#&gt; 10 2_counties &lt;NA&gt;   New Haven County white    557698  0.648</span>
<span class="co">#&gt; # ... with 80 more rows</span></code></pre></div>
<p>With the tenure table, it’s easiest to separate the labels by <code>"!!"</code>. Here the table can be wrangled into shares of households that are owner-occupied.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">homeownership &lt;-<span class="st"> </span>gnh_data<span class="op">$</span>tenure <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/label_acs.html">label_acs</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/separate">separate</a></span>(label, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">"total"</span>, <span class="st">"tenure"</span>), <span class="dt">sep =</span> <span class="st">"!!"</span>, <span class="dt">fill =</span> <span class="st">"left"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(level, <span class="dt">name =</span> NAME, tenure, estimate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(tenure <span class="op">!=</span><span class="st"> "Renter occupied"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(level, name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/camiller/topics/calc_shares">calc_shares</a></span>(<span class="dt">group =</span> tenure, <span class="dt">denom =</span> <span class="st">"Total"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(share))

homeownership
<span class="co">#&gt; # A tibble: 18 x 5</span>
<span class="co">#&gt; # Groups:   level, name [18]</span>
<span class="co">#&gt;    level      name                 tenure         estimate share</span>
<span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;                &lt;fct&gt;             &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1_state    Connecticut          Owner occupied   900223 0.665</span>
<span class="co">#&gt;  2 2_counties New Haven County     Owner occupied   203568 0.624</span>
<span class="co">#&gt;  3 3_regions  Greater New Haven    Owner occupied   106876 0.602</span>
<span class="co">#&gt;  4 3_regions  New Haven Inner Ring Owner occupied    34337 0.629</span>
<span class="co">#&gt;  5 3_regions  New Haven Outer Ring Owner occupied    58447 0.802</span>
<span class="co">#&gt;  6 4_towns    Bethany              Owner occupied     1807 0.904</span>
<span class="co">#&gt;  7 4_towns    Branford             Owner occupied     8331 0.679</span>
<span class="co">#&gt;  8 4_towns    East Haven           Owner occupied     7919 0.705</span>
<span class="co">#&gt;  9 4_towns    Guilford             Owner occupied     7314 0.855</span>
<span class="co">#&gt; 10 4_towns    Hamden               Owner occupied    15335 0.657</span>
<span class="co">#&gt; 11 4_towns    Madison              Owner occupied     5932 0.874</span>
<span class="co">#&gt; 12 4_towns    Milford              Owner occupied    16314 0.757</span>
<span class="co">#&gt; 13 4_towns    New Haven            Owner occupied    14092 0.282</span>
<span class="co">#&gt; 14 4_towns    North Branford       Owner occupied     4818 0.883</span>
<span class="co">#&gt; 15 4_towns    North Haven          Owner occupied     6969 0.833</span>
<span class="co">#&gt; 16 4_towns    Orange               Owner occupied     4267 0.867</span>
<span class="co">#&gt; 17 4_towns    West Haven           Owner occupied    11083 0.555</span>
<span class="co">#&gt; 18 4_towns    Woodbridge           Owner occupied     2695 0.919</span></code></pre></div>
</div>
<div id="visual-sketches" class="section level1">
<h1 class="hasAnchor">
<a href="#visual-sketches" class="anchor"></a>Visual sketches</h1>
<p><code>geo_level_plot</code> gives a quick visual overview of the homeownership rates, highlighting town-level values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">homeownership <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/geo_level_plot.html">geo_level_plot</a></span>(<span class="dt">value =</span> share, <span class="dt">hilite =</span> <span class="st">"darkslateblue"</span>, <span class="dt">type =</span> <span class="st">"point"</span>)</code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p><code>acs_quick_map</code> gives a quick map sketch of the rates. This function uses the Jenks algorithm for making breaks with <code><a href="http://www.rdocumentation.org/packages/classInt/topics/classIntervals">classInt::classIntervals</a></code>. This algorithm is well suited for visually displaying larger inequalities, but the number of breaks you give it won’t necessarily be the number of breaks returned. Here I supply <code>n = 6</code>, but the algorithm found instead that <code>n = 5</code> was the nearest <code>n</code> that could be used. This function lets us see whether there’s a geographic distribution of this data with minimal work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tenure_map &lt;-<span class="st"> </span>homeownership <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(level <span class="op">==</span><span class="st"> "4_towns"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/acs_quick_map.html">acs_quick_map</a></span>(<span class="dt">value =</span> share, <span class="dt">level =</span> <span class="st">"town"</span>, <span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="fl">0.4</span>, 
                <span class="dt">title =</span> <span class="st">"Homeownership, Greater New Haven"</span>, <span class="dt">palette =</span> <span class="st">"BuPu"</span>)

tenure_map</code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>Since this returns a <code>ggplot</code> object with <code>sf</code> data, we can add additional <code>ggplot</code> functions, such as labeling, themes, or additional scales or geoms.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tenure_map <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">subtitle =</span> <span class="st">"By town, 2016"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggsf">geom_sf</a></span>(<span class="dt">data =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(name <span class="op">==</span><span class="st"> "New Haven"</span>), <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggsf">coord_sf</a></span>(<span class="dt">ndiscr =</span> F)</code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
<div id="batch-output" class="section level1">
<h1 class="hasAnchor">
<a href="#batch-output" class="anchor"></a>Batch output</h1>
<p>Say as part of a pipeline, you need to do some calculations, write different sections of a data frame to CSV files to pass along to a colleague or refer to later, and then continue on to some more calculations. <code>batch_csv_dump</code> takes either a list of data frames or a data frame plus a column to split by, and writes out a set of CSV files, then lets you move along to the next step in your pipeline.</p>
<p>For example, I need to pull a table of populations by age group for several regions of Connecticut. I don’t need to split populations by gender, so I’ll add up male and female populations for each age group. I don’t actually need to more detailed age groups now, but I need to stash them in files for later, so I’ll aggregate, write a bunch of files, and then aggregate into broader age groups that I need for my current work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_haven_regions &lt;-<span class="st"> </span>regions[<span class="kw">c</span>(<span class="st">"Greater New Haven"</span>, <span class="st">"New Haven Inner Ring"</span>, 
                             <span class="st">"New Haven Outer Ring"</span>, <span class="st">"Lower Naugatuck Valley"</span>, <span class="st">"Greater Waterbury"</span>)]

acs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/multi_geo_acs.html">multi_geo_acs</a></span>(<span class="dt">table =</span> <span class="st">"B01001"</span>, <span class="dt">year =</span> <span class="dv">2016</span>, <span class="dt">towns =</span> <span class="ot">NULL</span>, <span class="dt">regions =</span> new_haven_regions, 
              <span class="dt">counties =</span> <span class="kw">c</span>(<span class="st">"New Haven County"</span>, <span class="st">"Fairfield County"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/label_acs.html">label_acs</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/separate">separate</a></span>(label, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">"total"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>), <span class="dt">sep =</span> <span class="st">"!!"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(age)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">age =</span> <span class="kw">as.factor</span>(age) <span class="op">%&gt;%</span><span class="st"> </span>forcats<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/forcats/topics/fct_inorder">fct_inorder</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(NAME, level, age) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">estimate =</span> <span class="kw">sum</span>(estimate), <span class="dt">moe =</span> tidycensus<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidycensus/topics/moe_sum">moe_sum</a></span>(moe, estimate) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>()


acs <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>NAME) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/batch_csv_dump.html">batch_csv_dump</a></span>(<span class="dt">base_name =</span> <span class="st">"pop_by_age"</span>, <span class="dt">bind =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(level, NAME) <span class="op">%&gt;%</span>
<span class="st">  </span>camiller<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/camiller/topics/add_grps">add_grps</a></span>(<span class="kw">list</span>(<span class="dt">ages0_4 =</span> <span class="dv">1</span>, <span class="dt">ages5_17 =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">ages0_17 =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">ages18_24 =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">ages0_24 =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>), <span class="dt">group =</span> age, <span class="dt">estimate =</span> estimate, <span class="dt">moe =</span> moe) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(level, NAME, age)</code></pre></div>
</div>
<div id="employment-trends" class="section level1">
<h1 class="hasAnchor">
<a href="#employment-trends" class="anchor"></a>Employment trends</h1>
<div id="quarterly-workforce-indicators" class="section level2">
<h2 class="hasAnchor">
<a href="#quarterly-workforce-indicators" class="anchor"></a>Quarterly Workforce Indicators</h2>
<p>I’m also interested in learning about employment by industry over the past several years. <code>qwi_industry</code> fetches county-level data by industry over time, either quarterly or annually. Here I’ll look at annual averages of all industries for New Haven County and Connecticut over the past 16 years. I’m filtering out the industry code “00”, which is the counts for all industries.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nhc_employment &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qwi_industry.html">qwi_industry</a></span>(<span class="dv">2002</span><span class="op">:</span><span class="dv">2017</span>, <span class="dt">counties =</span> <span class="st">"009"</span>, <span class="dt">annual =</span> T) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">location =</span> <span class="st">"New Haven County"</span>)
<span class="co">#&gt; The API can only get 10 years of data at once; making multiple calls, but this might take a little longer.</span>
ct_employment &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qwi_industry.html">qwi_industry</a></span>(<span class="dv">2002</span><span class="op">:</span><span class="dv">2017</span>, <span class="dt">annual =</span> T) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">location =</span> <span class="st">"Connecticut"</span>)
<span class="co">#&gt; The API can only get 10 years of data at once; making multiple calls, but this might take a little longer.</span>
employment &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(nhc_employment, ct_employment) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(industry <span class="op">!=</span><span class="st"> "00"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(naics_codes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>ind_level), <span class="dt">by =</span> <span class="st">"industry"</span>)

employment
<span class="co">#&gt; # A tibble: 640 x 8</span>
<span class="co">#&gt;     year industry state county   Emp  Payroll location    label           </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;           </span>
<span class="co">#&gt;  1  2002 11       09    009      707   1.67e7 New Haven … Agriculture, Fo…</span>
<span class="co">#&gt;  2  2002 21       09    009      194   1.01e7 New Haven … Mining, Quarryi…</span>
<span class="co">#&gt;  3  2002 22       09    009     1931   1.28e8 New Haven … Utilities       </span>
<span class="co">#&gt;  4  2002 23       09    009    15484   7.65e8 New Haven … Construction    </span>
<span class="co">#&gt;  5  2002 31-33    09    009    48176   2.42e9 New Haven … Manufacturing   </span>
<span class="co">#&gt;  6  2002 42       09    009    16640   9.41e8 New Haven … Wholesale Trade </span>
<span class="co">#&gt;  7  2002 44-45    09    009    46760   1.21e9 New Haven … Retail Trade    </span>
<span class="co">#&gt;  8  2002 48-49    09    009     7642   2.57e8 New Haven … Transportation …</span>
<span class="co">#&gt;  9  2002 51       09    009    14901   7.89e8 New Haven … Information     </span>
<span class="co">#&gt; 10  2002 52       09    009    13571   8.03e8 New Haven … Finance and Ins…</span>
<span class="co">#&gt; # ... with 630 more rows</span></code></pre></div>
<p>Next, say I want to look at the industries that were largest in New Haven county in 2017, and see how those have changed both for the county and statewide over this time period. I’ll filter <code>employment</code>, get the industries with the largest numbers of employees, then filter <code>employment</code> for just those industries and plot it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">top2017 &lt;-<span class="st"> </span>employment <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span>, county <span class="op">==</span><span class="st"> "009"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span>(<span class="dv">8</span>, Emp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(industry)
top2017
<span class="co">#&gt; [1] "31-33" "42"    "44-45" "54"    "56"    "62"    "72"    "81"</span>

employment <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(industry <span class="op">%in%</span><span class="st"> </span>top2017) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">label =</span> stringr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_sub">str_sub</a></span>(label, <span class="dv">1</span>, <span class="dv">25</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Emp =</span> Emp <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> year, <span class="dt">y =</span> Emp, <span class="dt">color =</span> label)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">x =</span> <span class="st">"Year"</span>, <span class="dt">y =</span> <span class="st">"Employees (thousands)"</span>, <span class="dt">title =</span> <span class="st">"Employment by industry"</span>, 
         <span class="dt">subtitle =</span> <span class="st">"Connecticut and New Haven County, 2002-2017"</span>, <span class="dt">color =</span> <span class="st">"Industry"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>location, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>If I’m interested in changes in wages over this period, I can use the <code>adj_inflation</code> function. This takes a data frame, the name of the column containing dollar amounts, and a base year, then adds two columns for the inflation adjustment factor and the adjusted value. The BLS hasn’t yet released a full year of data for 2017, so I’m filtering to remove 2017 and adjusting for inflation by 2016 dollars.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">employment <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(industry <span class="op">%in%</span><span class="st"> </span>top2017) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2017</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">label =</span> stringr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_sub">str_sub</a></span>(label, <span class="dv">1</span>, <span class="dv">25</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">avg_wage =</span> Payroll <span class="op">/</span><span class="st"> </span>Emp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/adj_inflation.html">adj_inflation</a></span>(<span class="dt">value =</span> avg_wage, <span class="dt">base_year =</span> <span class="dv">2016</span>, <span class="dt">year =</span> year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">adj_wage_1k =</span> <span class="kw">round</span>(adj_avg_wage <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> year, <span class="dt">y =</span> adj_wage_1k, <span class="dt">color =</span> label)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_continuous</a></span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">x =</span> <span class="st">"Year"</span>, <span class="dt">y =</span> <span class="st">"Average annual wages (thousands)"</span>, <span class="dt">title =</span> <span class="st">"Average annual wages by industry (adjusted to 2016 dollars)"</span>, 
         <span class="dt">subtitle =</span> <span class="st">"Connecticut and New Haven County, 2002-2016"</span>, <span class="dt">color =</span> <span class="st">"Industry"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>location, <span class="dt">scales =</span> <span class="st">"free_y"</span>)
<span class="co">#&gt; REQUEST_SUCCEEDED</span></code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>Now we have a visual that shows that in a few industries, wages have climbed over the past several years, but in many industries, wages haven’t increased except by inflation.</p>
</div>
<div id="local-area-unemployment-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#local-area-unemployment-statistics" class="anchor"></a>Local Area Unemployment Statistics</h2>
<p>To look at unemployment rates over time, I can use <code>laus_trend</code>. The LAUS covers smaller geographies than the QWI, so <code>laus_trend</code> is set up to find data by a combination of state, counties, or towns. The LAUS API returns monthly data on labor force counts, employment counts, unemployed counts, and unemployment rate; <code>laus_trend</code> lets you specify which of these measures to fetch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">unemployment &lt;-<span class="st"> </span><span class="kw"><a href="../reference/laus_trend.html">laus_trend</a></span>(<span class="kw">c</span>(<span class="st">"New Haven"</span>, <span class="st">"New Haven County"</span>, <span class="st">"Connecticut"</span>), <span class="dt">startyear =</span> <span class="dv">2000</span>, <span class="dt">endyear =</span> <span class="dv">2017</span>, <span class="dt">measures =</span> <span class="st">"unemployment rate"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">date =</span> <span class="kw">paste</span>(year, periodName, <span class="st">"01"</span>, <span class="dt">sep =</span> <span class="st">"-"</span>) <span class="op">%&gt;%</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">value =</span> value <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(area, date, value)
<span class="co">#&gt; REQUEST_SUCCEEDED</span>

unemployment
<span class="co">#&gt; # A tibble: 648 x 3</span>
<span class="co">#&gt;    area        date        value</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;date&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt;  1 Connecticut 2017-12-01 0.04  </span>
<span class="co">#&gt;  2 Connecticut 2017-11-01 0.0410</span>
<span class="co">#&gt;  3 Connecticut 2017-10-01 0.0410</span>
<span class="co">#&gt;  4 Connecticut 2017-09-01 0.042 </span>
<span class="co">#&gt;  5 Connecticut 2017-08-01 0.047 </span>
<span class="co">#&gt;  6 Connecticut 2017-07-01 0.049 </span>
<span class="co">#&gt;  7 Connecticut 2017-06-01 0.048 </span>
<span class="co">#&gt;  8 Connecticut 2017-05-01 0.047 </span>
<span class="co">#&gt;  9 Connecticut 2017-04-01 0.047 </span>
<span class="co">#&gt; 10 Connecticut 2017-03-01 0.051 </span>
<span class="co">#&gt; # ... with 638 more rows</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(unemployment, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> value, <span class="dt">group =</span> area, <span class="dt">color =</span> area)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_smooth">geom_smooth</a></span>(<span class="dt">se =</span> F, <span class="dt">method =</span> <span class="st">"loess"</span>, <span class="dt">size =</span> <span class="fl">0.8</span>)</code></pre></div>
<p><img src="basic-workflow_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#fetching-data-from-acs">Fetching data from ACS</a></li>
      <li><a href="#aggregating-and-analyzing-data">Aggregating and analyzing data</a></li>
      <li><a href="#visual-sketches">Visual sketches</a></li>
      <li><a href="#batch-output">Batch output</a></li>
      <li>
<a href="#employment-trends">Employment trends</a><ul class="nav nav-pills nav-stacked">
<li><a href="#quarterly-workforce-indicators">Quarterly Workforce Indicators</a></li>
      <li><a href="#local-area-unemployment-statistics">Local Area Unemployment Statistics</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Camille Seaberry.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
